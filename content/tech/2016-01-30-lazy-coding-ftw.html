<!-- title: Lazy coding for the win -->
<p>Its been a while since I wrote any new hook scripts so I thought I would refresh my knowledge before talking about them at <a href="http://phpconference.co.uk">phpconference.co.uk</a>. I also love playing around with python - it's straight forward, pretty and gives good 'sad puppy' feedback when you've missed a closing bracket.</p>
<p>So I came up with this beast to turn svn log output into a dictionary. You can then do what you like with it: output to a file, turn into html, stream to a feed, whatever.</p>
<div style="font-size:clamp(14px, .875rem, 21px);line-height:clamp(20px, 1.25rem, 30px)">
<pre class="shiki" style="background-color: #2e3440ff">
<code>
    <span class="line"><span style="color: #81A1C1">from</span><span style="color: #D8DEE9FF"> subprocess </span><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> check_output</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #D8DEE9FF">repo_cmd </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">svn log file:///svnrepro/tests/deleteFile/trunk</span><span style="color: #ECEFF4">&quot;</span></span>
    <span class="line"><span style="color: #D8DEE9FF">output </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">check_output</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">repo_cmd</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">shell</span><span style="color: #81A1C1">=True</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #D8DEE9FF">demarker </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">--------------------------------------------------------</span><span style="color: #EBCB8B">\</span><span style="color: #ECEFF4">&quot;</span></span>
    <span class="line"><span style="color: #D8DEE9FF">contents </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> output</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">split</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">demarker</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #D8DEE9FF">ignore_these </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">[hotfix]</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">[merge]</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">]</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #D8DEE9FF">log_book </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">list</span><span style="color: #ECEFF4">()</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #81A1C1">for</span><span style="color: #D8DEE9FF"> section </span><span style="color: #81A1C1">in</span><span style="color: #D8DEE9FF"> contents</span><span style="color: #ECEFF4">:</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    lines </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> section</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">split</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">&quot;</span><span style="color: #EBCB8B">\\</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">len</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">lines</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&lt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">2</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">continue</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    commit_info </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> lines</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">0</span><span style="color: #ECEFF4">]</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    message </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> lines</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">1</span><span style="color: #ECEFF4">].</span><span style="color: #88C0D0">strip</span><span style="color: #ECEFF4">()</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    ignore </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">False</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">for</span><span style="color: #D8DEE9FF"> prefix </span><span style="color: #81A1C1">in</span><span style="color: #D8DEE9FF"> ignore_these</span><span style="color: #ECEFF4">:</span></span>
    <span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> message</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">startswith</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">prefix</span><span style="color: #ECEFF4">):</span></span>
    <span class="line"><span style="color: #D8DEE9FF">            ignore </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">True</span></span>
    <span class="line"><span style="color: #D8DEE9FF">            </span><span style="color: #81A1C1">break</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> ignore </span><span style="color: #81A1C1">==</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">True</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">continue</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    info </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> commit_info</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">split</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">|</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    section </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">dict</span><span style="color: #ECEFF4">()</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    section</span><span style="color: #ECEFF4">[</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">revision</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">]</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> info</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">0</span><span style="color: #ECEFF4">].</span><span style="color: #88C0D0">strip</span><span style="color: #ECEFF4">().</span><span style="color: #88C0D0">replace</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">r</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&quot;&quot;</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    section</span><span style="color: #ECEFF4">[</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">user</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">]</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> info</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">1</span><span style="color: #ECEFF4">].</span><span style="color: #88C0D0">strip</span><span style="color: #ECEFF4">()</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    section</span><span style="color: #ECEFF4">[</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">date</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">]</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> info</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">2</span><span style="color: #ECEFF4">].</span><span style="color: #88C0D0">strip</span><span style="color: #ECEFF4">()</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    length </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> info</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">3</span><span style="color: #ECEFF4">].</span><span style="color: #88C0D0">strip</span><span style="color: #ECEFF4">().</span><span style="color: #88C0D0">split</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C"> </span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    section</span><span style="color: #ECEFF4">[</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">messageLength</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">]</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> length</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">0</span><span style="color: #ECEFF4">]</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    section</span><span style="color: #ECEFF4">[</span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">message</span><span style="color: #ECEFF4">&quot;</span><span style="color: #ECEFF4">]</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> message</span></span>
    <span class="line"><span style="color: #D8DEE9FF">    log_book</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">append</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">section</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #88C0D0">print</span><span style="color: #D8DEE9FF"> log_book</span></span>
    <span class="line"></span>
</code>
</pre>
</div>
<p>What can I say, I like understanding things at a first principles level.</p>
<p>Of course then I remembered a cool flag which turns a predetermined text output into something much more meaningful.</p>
<div style="font-size:clamp(14px, .875rem, 21px);line-height:clamp(20px, 1.25rem, 30px)">
<pre class="shiki" style="background-color: #2e3440ff">
<code>
    <span class="line"><span style="color: #D8DEE9FF">repo_cmd </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">svn log --xml file:///svnrepro/tests/deleteFile/trunk</span><span style="color: #ECEFF4">&quot;</span></span>
</code>
</pre>
</div>
<p><a title="xml.etree.ElementTree: Implementation of the ElementTree API." href="https://docs.python.org/2/library/xml.etree.elementtree.html#module-xml.etree.ElementTree">xml.etree.ElementTree</a>&nbsp;is the built in python way of handling xml and, again, it's a bit hand cranked and leads to many unnecessary lines of code. So why re-invent the wheel?</p>
<p>"Has someone already done this?" is rapidly becoming my first question, and yes, someone has!</p>
<p><a href="https://github.com/martinblech/xmltodict">https://github.com/martinblech/xmltodict</a></p>
<p>This is the second module library I tried, and is one that can actually deal with lists of elements - essential for svn log output. If you are used to handling things in JSON, it's really easy:</p>
<div style="font-size:clamp(14px, .875rem, 21px);line-height:clamp(20px, 1.25rem, 30px)">
<pre class="shiki" style="background-color: #2e3440ff">
<code>
    <span class="line"><span style="color: #81A1C1">from</span><span style="color: #D8DEE9FF"> subprocess </span><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> check_output</span></span>
    <span class="line"><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> json</span></span>
    <span class="line"><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> xmltodict</span></span>
    <span class="line"><span style="color: #616E88"># https://github.com/martinblech/xmltodict</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #D8DEE9FF">repo_cmd </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&quot;</span><span style="color: #A3BE8C">svn log --xml file:///svnrepro/tests/deleteFile/trunk</span><span style="color: #ECEFF4">&quot;</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #D8DEE9FF">output </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">check_output</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">repo_cmd</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">shell</span><span style="color: #81A1C1">=True</span><span style="color: #ECEFF4">)</span></span>
    <span class="line"></span>
    <span class="line"><span style="color: #88C0D0">print</span><span style="color: #D8DEE9FF"> json</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">dumps</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">xmltodict</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">parse</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">output</span><span style="color: #ECEFF4">))</span></span>
    <span class="line"></span>
</code>
</pre>
</div>
<p>I have to admit, a little piece of me feels like I'm no longer writing 'real' code and that there's nothing left unsolved or uncoded. The rest of me is doing a happy dance - now we are freed up to use technology to solve the real issues - save time, collaborate well and communicate effectively to make lives better!</p>
